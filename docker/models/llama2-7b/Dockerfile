# Llama2 7B Pre-built Docker Image
ARG BASE_IMAGE_URI
FROM ${BASE_IMAGE_URI}:latest

# ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
LABEL model="llama2:7b"
LABEL model_size="7B"
LABEL category="chat"

# ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ç’°å¢ƒå¤‰æ•°
ENV MODEL_NAME=llama2:7b
ENV PRELOAD_MODEL=true
ENV OLLAMA_MAX_LOADED_MODELS=1

# rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸€æ™‚çš„ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
USER root

# ãƒ¢ãƒ‡ãƒ«ã‚’äº‹å‰ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
RUN echo "ğŸ“¦ Pre-downloading Llama2 7B model..." && \
    # Ollamaã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
    su - ollama -c "ollama serve &" && \
    sleep 10 && \
    # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    su - ollama -c "ollama pull llama2:7b" && \
    # ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    pkill -f ollama || true && \
    sleep 5 && \
    echo "âœ… Llama2 7B model pre-downloaded"

# ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
RUN if [ -d "/home/ollama/.ollama/models" ]; then \
        echo "ğŸ“ Model files:"; \
        find /home/ollama/.ollama/models -name "*.bin" -o -name "*.gguf" | head -5; \
        echo "ğŸ’¾ Total model size: $(du -sh /home/ollama/.ollama/models | cut -f1)"; \
    else \
        echo "âš ï¸  Warning: Model directory not found"; \
    fi

# æ¨©é™ã‚’ä¿®æ­£
RUN chown -R ollama:ollama /home/ollama/.ollama

# ollamaãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æˆ»ã™
USER ollama

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¢ãƒ‡ãƒ«å›ºæœ‰ï¼‰
HEALTHCHECK --interval=30s --timeout=15s --start-period=120s --retries=3 \
    CMD /app/healthcheck.sh

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§llama2:7bãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
ENV MODEL_NAME=llama2:7b
